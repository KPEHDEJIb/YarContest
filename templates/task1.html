{% extends "base.html" %}

{% block title %}{{ task.title }}{% endblock %}

{% block content %}
    <div class="container">
        <h2>{{ task.title }}</h2>
        <div class="task-description">
            <h3>Условие задачи</h3>
            <p>{{ task.description }}</p>
            
            <h3>Примеры</h3>
            {% for example in task.examples %}
            <div class="example">
                <div class="example-input">
                    <h4>Входные данные</h4>
                    <pre>{{ example.input if example.input else "∅" }}</pre>
                </div>
                <div class="example-output">
                    <h4>Выходные данные</h4>
                    <pre>{{ example.output }}</pre>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <div class="solution-area" id="solutionArea">
            <h3>Ваше решение</h3>
            <form id="solutionForm">
                <textarea name="code" id="code" placeholder="Введите ваш код на Python">{% if request.args.get('code') %}{{ request.args.get('code') }}{% else %}print("Hello, world!"){% endif %}</textarea>
                <button type="submit" id="submitBtn">Проверить</button>
            </form>
            
            <div class="result" id="result">
                <h3>Результат проверки</h3>
                <div class="status" id="status">Статус: <span id="statusText">Не отправлено</span></div>
                <div class="output" id="outputContainer" style="display: none;">
                    <h4>Вывод программы:</h4>
                    <pre id="programOutput"></pre>
                </div>
                <div class="comparison" id="comparisonContainer" style="display: none;">
                    <h4>Ожидаемый вывод:</h4>
                    <pre id="expectedOutput"></pre>
                </div>
                <div class="error" id="errorContainer" style="display: none;">
                    <h4>Ошибка:</h4>
                    <pre id="errorOutput"></pre>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        document.getElementById('solutionForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const solutionArea = document.getElementById('solutionArea');
            const submitBtn = document.getElementById('submitBtn');
            const statusText = document.getElementById('statusText');
            const outputContainer = document.getElementById('outputContainer');
            const programOutput = document.getElementById('programOutput');
            const comparisonContainer = document.getElementById('comparisonContainer');
            const expectedOutput = document.getElementById('expectedOutput');
            const errorContainer = document.getElementById('errorContainer');
            const errorOutput = document.getElementById('errorOutput');
            
            // Сбрасываем предыдущие результаты
            outputContainer.style.display = 'none';
            comparisonContainer.style.display = 'none';
            errorContainer.style.display = 'none';
            
            // Показываем процесс проверки
            solutionArea.classList.add('checking');
            submitBtn.disabled = true;
            statusText.textContent = 'Проверка...';
            
            // Отправляем код на сервер
            fetch('/submit/task1', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams(new FormData(this))
            })
            .then(response => response.json())
            .then(data => {
                // Обновляем статус
                let statusClass = '';
                if (data.status === 'OK') {
                    statusText.textContent = 'Статус: OK';
                    statusClass = 'success';
                } else {
                    statusText.textContent = `Статус: ${data.status}`;
                    statusClass = 'error';
                }
                
                // Показываем вывод программы
                if (data.output !== undefined) {
                    programOutput.textContent = data.output;
                    outputContainer.style.display = 'block';
                }
                
                // Показываем сравнение при WA
                if (data.status === 'WA') {
                    expectedOutput.textContent = data.expected;
                    comparisonContainer.style.display = 'block';
                }
                
                // Показываем ошибку при наличии
                if (data.error) {
                    errorOutput.textContent = data.error;
                    errorContainer.style.display = 'block';
                }
                
                // Обновляем классы для отображения статуса
                solutionArea.classList.remove('checking');
                solutionArea.classList.add(statusClass);
            })
            .catch(error => {
                statusText.textContent = 'Статус: Ошибка при проверке';
                errorOutput.textContent = error.message;
                errorContainer.style.display = 'block';
                solutionArea.classList.remove('checking');
                solutionArea.classList.add('error');
            })
            .finally(() => {
                submitBtn.disabled = false;
            });
        });
    </script>
{% endblock %}