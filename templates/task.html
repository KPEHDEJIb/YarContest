{% extends "base.html" %}

{% block title %}{{ task.title }}{% endblock %}

{% block content %}
    <div class="container">
        <h2>{{ task.title }}</h2>
        <div class="task-description">
            <h3>Условие задачи</h3>
            <p>{{ task.description }}</p>
            
            <h3>Примеры</h3>
            {% for example in task.examples %}
            <div class="example">
                <div class="example-input">
                    <h4>Входные данные</h4>
                    <pre>{{ example.input if example.input else "∅" }}</pre>
                </div>
                <div class="example-output">
                    <h4>Выходные данные</h4>
                    <pre>{{ example.output }}</pre>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <div class="solution-area" id="solutionArea">
            <h3>Ваше решение</h3>
            <form id="solutionForm">
                <textarea name="code" id="code" placeholder="Введите ваш код на Python">{% if request.args.get('code') %}{{ request.args.get('code') }}{% else %}{% if task.title == 'Сумма двух чисел' %}a = int(input())\nb = int(input())\nprint(a + b){% else %}print("Hello, world!"){% endif %}{% endif %}</textarea>
                <button type="submit" id="submitBtn">Проверить</button>
            </form>

            <div class="result" id="result">
                <h3>Результат проверки</h3>
                <div class="status">
                    <span id="statusText">Не отправлено</span> |
                    <span id="testSummary">Тестов пройдено: <span id="passedCount">0</span>/<span id="totalCount">0</span></span>
                </div>
                <div id="testResultsContainer"></div>
                <div class="error" id="errorContainer" style="display: none;">
                    <h4>Ошибка:</h4>
                    <pre id="errorOutput"></pre>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('solutionForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const solutionArea = document.getElementById('solutionArea');
            const submitBtn = document.getElementById('submitBtn');
            const statusText = document.getElementById('statusText');
            const testResultsContainer = document.getElementById('testResultsContainer');
            const errorContainer = document.getElementById('errorContainer');
            const errorOutput = document.getElementById('errorOutput');
            const passedCount = document.getElementById('passedCount');
            const totalCount = document.getElementById('totalCount');
            const testSummary = document.getElementById('testSummary');

            // Сбрасываем предыдущие результаты
            testResultsContainer.innerHTML = '';
            errorContainer.style.display = 'none';

            // Показываем процесс проверки
            solutionArea.classList.add('checking');
            submitBtn.disabled = true;
            statusText.textContent = 'Проверка...';

            // Отправляем код на сервер
            fetch('/submit/{% if task.title == "Сумма двух чисел" %}task2{% else %}task1{% endif %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams(new FormData(this))
            })
            .then(response => response.json())
            .then(data => {
                // Обновляем статус
                if (data.all_passed) {
                    statusText.textContent = 'Все тесты пройдены';
                    solutionArea.classList.add('success');
                    solutionArea.classList.remove('error');
                } else {
                    statusText.textContent = 'Тесты не пройдены';
                    solutionArea.classList.add('error');
                    solutionArea.classList.remove('success');
                }

                // Считаем пройденные тесты
                const passed = data.test_results.filter(t => t.passed).length;
                const total = data.test_results.length;
                passedCount.textContent = passed;
                totalCount.textContent = total;

                // Отображаем результаты тестов
                data.test_results.forEach(test => {
                    const testResult = document.createElement('div');
                    testResult.className = `test-result ${test.passed ? 'success' : 'failure'}`;

                    const testHeader = document.createElement('div');
                    testHeader.className = 'test-header';
                    testHeader.innerHTML = `
                        <span>Тест #${test.test_number} - ${test.passed ? 'Пройден' : 'Не пройден'}</span>
                        <span class="test-toggle">▶</span>
                    `;

                    const testContent = document.createElement('div');
                    testContent.className = 'test-content';
                    testContent.innerHTML = `
                        <p><strong>Входные данные:</strong></p>
                        <pre>${test.input || "∅"}</pre>
                        ${test.error ? `
                            <p><strong>Ошибка:</strong></p>
                            <pre>${test.error}</pre>
                            <p><strong>Статус:</strong> ${test.status}</p>
                        ` : `
                            <p><strong>Ожидаемый вывод:</strong></p>
                            <pre>${test.expected}</pre>
                            <p><strong>Полученный вывод:</strong></p>
                            <pre>${test.output}</pre>
                            <p><strong>Статус:</strong> ${test.passed ? 'OK' : 'WA'}</p>
                        `}
                        <p><strong>Время выполнения:</strong> ${test.time.toFixed(3)} сек.</p>
                    `;

                    testHeader.addEventListener('click', () => {
                        testContent.classList.toggle('show');
                        const toggle = testHeader.querySelector('.test-toggle');
                        toggle.classList.toggle('rotated');
                    });

                    testResult.appendChild(testHeader);
                    testResult.appendChild(testContent);
                    testResultsContainer.appendChild(testResult);
                });
            })
            .catch(error => {
                statusText.textContent = 'Ошибка при проверке';
                errorOutput.textContent = error.message;
                errorContainer.style.display = 'block';
                solutionArea.classList.remove('checking');
                solutionArea.classList.add('error');
            })
            .finally(() => {
                submitBtn.disabled = false;
                solutionArea.classList.remove('checking');
            });
        });
    </script>
{% endblock %}